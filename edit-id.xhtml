<xhtml:html xmlns="http://www.w3.org/1999/xhtml" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:exist="http://exist.sourceforge.net/NS/exist" xmlns:nm="http://nomisma.org/id/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:skos="http://www.w3.org/2008/05/skos#"
	xmlns:numishare="http://code.google.com/p/numishare/" xmlns:nuds="http://nomisma.org/nuds" xmlns:nh="http://nomisma.org/nudsHoard" xmlns:gml="http://www.opengis.net/gml/"
	xmlns:xlink="http://www.w3.org/1999/xlink">
	<xhtml:head>
		<xhtml:title>nomisma.org: Administrative Interface</xhtml:title>
		<xhtml:link rel="stylesheet" type="text/css" href="/apps/nomisma/css/grids-min.css"/>
		<xhtml:link rel="stylesheet" type="text/css" href="/apps/nomisma/css/reset-fonts-grids.css"/>
		<xhtml:link rel="stylesheet" type="text/css" href="/apps/nomisma/css/base-min.css"/>
		<xhtml:link rel="stylesheet" type="text/css" href="/apps/nomisma/css/fonts-min.css"/>

		<!-- nomisma styling -->
		<xhtml:link rel="stylesheet" href="/apps/nomisma/css/style.css"/>
		<!--<link rel="stylesheet" href="/apps/nomisma/css/themes/smoothness.css"/>-->

		<!--<script type="text/javascript" src="{$display_path}javascript/jquery-1.4.2.min.js"/>
		<script type="text/javascript" src="{$display_path}javascript/get_components.js"/>
		<script type="text/javascript" src="{$display_path}javascript/menu.js"/>-->


		<xforms:model>
			<xs:schema elementFormDefault="qualified" attributeFormDefault="unqualified">
				<xs:simpleType name="iso8601date">
					<xs:restriction base="xs:string">
						<xs:pattern
							value="(\-?(0|1|2)([0-9]{3})(((01|02|03|04|05|06|07|08|09|10|11|12)((0[1-9])|((1|2)[0-9])|(3[0-1])))|\-((01|02|03|04|05|06|07|08|09|10|11|12)(\-((0[1-9])|((1|2)[0-9])|(3[0-1])))?))?)(/\-?(0|1|2)([0-9]{3})(((01|02|03|04|05|06|07|08|09|10|11|12)((0[1-9])|((1|2)[0-9])|(3[0-1])))|\-((01|02|03|04|05|06|07|08|09|10|11|12)(\-((0[1-9])|((1|2)[0-9])|(3[0-1])))?))?)?"
						/>
					</xs:restriction>
				</xs:simpleType>
				<xs:simpleType name="iso8601year">
					<xs:restriction base="xs:string">
						<xs:pattern value="\-?(0|1|2)([0-9]{3})"/>
					</xs:restriction>
				</xs:simpleType>
			</xs:schema>

			<xforms:instance id="doc">
				<div xmlns="http://www.w3.org/1999/xhtml"
					prefix="=nm: http://nomisma.org/id/ dcterms: http://purl.org/dc/terms/ rdfs: http://www.w3.org/2000/01/rdf-schema# foaf: http://xmlns.com/foaf/0.1/ rdf:  http://www.w3.org/1999/02/22-rdf-syntax-ns# owl:  http://www.w3.org/2002/07/owl# rdfs: http://www.w3.org/2000/01/rdf-schema#	 rdfa: http://www.w3.org/ns/rdfa#"
					about="" typeof="">
					<div property="skos:prefLabel" xml:lang="en"/>
					<div property="skos:definition" xml:lang="en"/>
				</div>
			</xforms:instance>

			<xforms:instance id="coin">
				<nuds recordType="conceptual" xmlns="http://nomisma.org/nuds" xmlns:mets="http://www.loc.gov/METS/" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:gml="http://www.opengis.net/gml">
					<nudsHeader>
						<nudsid/>
						<publicationStmt>
							<publisher/>
							<createdBy/>
							<date normal=""/>
							<langUsage>
								<language langcode=""/>
							</langUsage>
						</publicationStmt>
						<rightsStmt>
							<copyrightHolder/>
							<!--<date normal=""/>-->
						</rightsStmt>
					</nudsHeader>
					<descMeta>
						<title/>
						<typeDesc>
							<objectType/>
						</typeDesc>
					</descMeta>
				</nuds>
			</xforms:instance>

			<xforms:instance id="hoard">
				<nudsHoard xmlns="http://nomisma.org/nudsHoard" xmlns:nuds="http://nomisma.org/nuds" xmlns:xlink="http://www.w3.org/1999/xlink">
					<nudsHeader>
						<nudsid/>
						<publicationStmt>
							<publisher/>
							<createdBy/>
							<date normal=""/>
							<langUsage>
								<language langcode=""/>
							</langUsage>
						</publicationStmt>
						<rightsStmt>
							<copyrightHolder/>
							<!--<date normal=""/>-->
						</rightsStmt>
					</nudsHeader>
					<descMeta>
						<hoardDesc>
							<findspot/>
						</hoardDesc>
						<contentsDesc>
							<contents/>
						</contentsDesc>
					</descMeta>
				</nudsHoard>
			</xforms:instance>

			<xforms:instance id="kml">
				<kml xmlns="http://www.opengis.net/kml/2.2"/>
			</xforms:instance>

			<xforms:instance id="exist-url">
				<xi:include href="exist-url.xml"/>
			</xforms:instance>

			<xforms:instance id="config">
				<config xmlns=""/>
			</xforms:instance>

			<xforms:instance id="control-instance">
				<controls xmlns="">
					<id/>
					<original_id/>
					<type/>
					<prefLabel/>
					<lat/>
					<lon/>
				</controls>
			</xforms:instance>

			<xforms:instance id="status">
				<status/>
			</xforms:instance>

			<xforms:instance id="languages">
				<languages xmlns="">
					<language value="nl">Dutch</language>
					<language value="en">English</language>
					<language value="fr">French</language>
					<language value="de">German</language>
					<language value="el">Greek</language>
					<language value="it">Italian</language>
				</languages>
			</xforms:instance>

			<!-- other templates -->
			<xforms:instance id="concept-template">
				<skos:Concept rdf:about="" xmlns="">
					<skos:broader rdf:about=""/>
					<skos:prefLabel xml:lang="en"/>
				</skos:Concept>
			</xforms:instance>

			<xforms:instance id="prefLabel-template">
				<div property="skos:prefLabel" xml:lang=""/>
			</xforms:instance>

			<xforms:instance id="altLabel-template">
				<div property="skos:altLabel" xml:lang=""/>
			</xforms:instance>

			<xforms:instance id="related-template">
				<div>
					<a rel="skos:related" xml:lang="" href=""/>
				</div>
			</xforms:instance>

			<xforms:instance id="latlongsource-template">
				<div>
					<a rel="nm:latlongsource" xml:lang="" href=""/>
				</div>
			</xforms:instance>

			<xforms:instance id="definition-template">
				<div property="skos:definition" xml:lang=""/>
			</xforms:instance>

			<xforms:instnace id="coordinates-template">
				<div property="gml:pos"/>
			</xforms:instnace>

			<!-- eXist query for types -->
			<xforms:instance id="eXist-xquery">
				<exist:query xmlns:exist="http://exist.sourceforge.net/NS/exist">
					<exist:text>&lt;report&gt; { for $i in distinct-values(collection()//xhtml:div/@typeof) where string-length(normalize-space($i)) &gt; 0order by substring-after($i,
						'nm:') return &lt;type> { substring-after($i, 'nm:') } &lt;/type> } &lt;/report&gt;</exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="types">tring-le <exist:result/>
			</xforms:instance>

			<!-- Solr instances -->
			<xforms:instance id="addIndex">
				<add xmlns=""/>
			</xforms:instance>
			<xforms:instance id="sendCommit">
				<commit/>
			</xforms:instance>


			<!-- **************** BINDINGS ********************** -->
			<xforms:bind nodeset="instance('control-instance')">
				<xforms:bind nodeset="id" required="true()" type="xs:anyURI"/>
				<xforms:bind nodeset="type">
					<xforms:bind constraint="string-length(.) &gt; 0"/>
				</xforms:bind>
				<xforms:bind nodeset="lat" type="xs:double">
					<xforms:bind constraint=". &gt; -180 and . &lt; 180"/>
				</xforms:bind>
				<xforms:bind nodeset="lon" type="xs:double">
					<xforms:bind constraint=". &gt; -180 and . &lt; 180"/>
				</xforms:bind>
			</xforms:bind>

			<xforms:bind nodeset="instance('doc')">
				<xforms:bind nodeset="xhtml:div[@property='skos:prefLabel']" required="true()">
					<xforms:bind nodeset="@xml:lang" constraint="string-length(.) &gt; 0"/>
				</xforms:bind>
				<xforms:bind nodeset="xhtml:div[@property='skos:altLabel']" required="true()">
					<xforms:bind nodeset="@xml:lang" constraint="string-length(.) &gt; 0"/>
				</xforms:bind>
				<xforms:bind nodeset="xhtml:div[@property='skos:definition']">
					<xforms:bind nodeset="@xml:lang" constraint="string-length(.) &gt; 0"/>
				</xforms:bind>
				<xforms:bind nodeset="xhtml:div/xhtml:a[@rel='skos:related']">
					<xforms:bind nodeset="@href" required="true()" type="xs:anyURI"/>
				</xforms:bind>
				<xforms:bind nodeset="xhtml:div/xhtml:a[@rel='nm:latlongsource']">
					<xforms:bind nodeset="@href" required="true()" type="xs:anyURI"/>
				</xforms:bind>
			</xforms:bind>

			<xforms:bind nodeset="instance('coin')">
				<xforms:bind nodeset="nuds:nudsHeader">
					<xforms:bind nodeset="nuds:nudsid" required="true()" type="xs:anyURI"/>
					<xforms:bind nodeset="nuds:publicationStmt">
						<xforms:bind nodeset="nuds:publisher" required="true()"/>
						<xforms:bind nodeset="nuds:createdBy" required="true()"/>
						<xforms:bind nodeset="nuds:date">
							<xforms:bind nodeset="@normal" type="xs:date"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:project"/>
						<xforms:bind nodeset="nuds:language" required="true()">
							<xforms:bind constraint="string-length(@langcode) &gt; 0"/>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="nuds:rightsStmt">
						<xforms:bind nodeset="nuds:copyrightHolder" required="true()"/>
					</xforms:bind>
				</xforms:bind>
				<xforms:bind nodeset="//nuds:reference">
					<xforms:bind nodeset="nuds:title" required="true()"/>
					<xforms:bind nodeset="nuds:identifier" required="true()"/>
				</xforms:bind>
				<xforms:bind nodeset="nuds:descMeta">
					<xforms:bind nodeset="nuds:title" required="true()"/>
					<xforms:bind nodeset="nuds:typeDesc">
						<xforms:bind nodeset="@xlink:href" required="true()" type="xs:anyURI"/>
						<xforms:bind nodeset="nuds:objectType">
							<xforms:bind constraint="string-length(.) &gt; 0"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:date" required="true()">
							<xforms:bind nodeset="@normal" type="iso8601date"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:denomination">
							<xforms:bind constraint="string-length(.) &gt; 0"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:manufacture">
							<xforms:bind constraint="string-length(.) &gt; 0"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:material">
							<xforms:bind constraint="string-length(.) &gt; 0"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:weightStandard" required="true()" type="xs:decimal">
							<xforms:bind nodeset="@origin" required="true()"/>
						</xforms:bind>
						<xforms:bind nodeset="nuds:authority">
							<xforms:bind nodeset="*" constraint="string-length(.) &gt; 0">
								<xforms:bind nodeset="@xlink:title">
									<xforms:bind constraint="string-length(.) &gt; 0"/>
								</xforms:bind>
								<xforms:bind nodeset="@xlink:href">
									<xforms:bind constraint="string-length(.) &gt; 0"/>
								</xforms:bind>
							</xforms:bind>
						</xforms:bind>
					</xforms:bind>
					<xforms:bind nodeset="nuds:associatedObject">
						<xforms:bind nodeset="@xlink:href" required="true()" type="xs:anyURI"/>
					</xforms:bind>
				</xforms:bind>
			</xforms:bind>

			<!-- tab bindings -->
			<xforms:bind id="typeDesc-tab" nodeset="instance('coin')/nuds:descMeta/nuds:typeDesc"/>
			<xforms:bind id="nudsHeader-tab" nodeset="instance('coin')/nuds:nudsHeader"/>

			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:send submission="load-config"/>
				<xforms:send submission="xquery-collection"/>
				<xforms:action if="string(xxforms:get-request-parameter('id'))">
					<xforms:setvalue ref="instance('control-instance')/id" value="xxforms:get-request-parameter('id')"/>
					<xforms:setvalue ref="instance('control-instance')/original_id" value="xxforms:get-request-parameter('id')"/>
					<xforms:send submission="load-id"/>
				</xforms:action>

				<!--<xforms:setvalue ref="instance('control-instance')/id" value="substring-before(substring-after(instance('doc')/@about, 'nm:'), ']')"/>-->

			</xforms:action>

			<xforms:action ev:event="xforms-ready">
				<xforms:action if="instance('control-instance')/type = 'type_series_item'">
					<xforms:toggle case="coin-type"/>
				</xforms:action>
				<xforms:action if="instance('control-instance')/type = 'hoard'">
					<xforms:toggle case="hoard-case"/>
				</xforms:action>
				<xforms:action if="not(instance('control-instance')/type = 'type_series_item') and not(instance('control-instance')/type = 'hoard')">
					<xforms:toggle case="default"/>
				</xforms:action>
			</xforms:action>

			<!-- ************* SUBMISSIONS **********************-->
			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-url')}nomisma/config.xml" replace="instance" instance="config" xxforms:username="admin"
				xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load config</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-id" serialization="none" method="get" action="{instance('exist-url')}nomisma/id/{instance('control-instance')/id}.xml" replace="instance" instance="doc"
				xxforms:username="admin" xxforms:password="">
				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('control-instance')/prefLabel" value="instance('doc')/div[@property='skos:prefLabel'][@xml:lang='en']"/>
					<xforms:setvalue ref="instance('control-instance')/type" value="substring-after(instance('doc')/@typeof, 'nm:')"/>
					<xforms:action if="not(instance('control-instance')/type = 'hoard') and not(instance('control-instance')/type = 'type_series_item')">
						<!-- populate lat, lon -->
						<xforms:setvalue ref="instance('control-instance')/lat" value="tokenize(instance('doc')/xhtml:div[@property='gml:pos'], ' ')[1]"/>
						<xforms:setvalue ref="instance('control-instance')/lon" value="tokenize(instance('doc')/xhtml:div[@property='gml:pos'], ' ')[2]"/>
					</xforms:action>
					<xforms:action if="instance('control-instance')/type = 'type_series_item'">
						<xforms:send submission="load-coin"/>
					</xforms:action>
					<xforms:action if="instance('control-instance')/type = 'hoard'">
						<xforms:send submission="load-hoard"/>
					</xforms:action>
				</xforms:action>
				<!-- if config.xml doesn't exist, then create the exist collection with necessary files -->
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">Error Loading id</xforms:message>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="save-id" ref="instance('doc')" xxforms:username="admin" xxforms:password="" action="{instance('exist-url')}nomisma/id/{instance('control-instance')/id}.xml"
				method="put" replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Save Error. Are all required inputs filled?</xforms:message>

				<xforms:action ev:event="xforms-submit-done">
					<xforms:setvalue ref="instance('status')">id saved</xforms:setvalue>
					<xforms:setvalue ref="instance('control-instance')/original_id" value="instance('control-instance')/id"/>
					<!-- post to solr -->
					<xforms:insert nodeset="instance('addIndex')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-solr.xpl', 'data', instance('doc'), 'data')"/>
					<xforms:send submission="post-solr-doc"/>
				</xforms:action>
			</xforms:submission>

			<!-- **** NUDS **** -->
			<xforms:submission id="load-coin" serialization="none" method="get" action="{instance('exist-url')}nomisma/objects/{instance('control-instance')/id}.xml" replace="instance" instance="coin"
				xxforms:username="admin" xxforms:password="">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">Error Loading object</xforms:message>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="save-coin" ref="instance('coin')" xxforms:username="admin" xxforms:password="" action="{instance('exist-url')}nomisma/objects/{instance('control-instance')/id}.xml"
				method="put" replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Save Error. Are all required inputs filled?</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:insert nodeset="instance('doc')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/nuds-to-rdf.xpl', 'data', instance('coin'), 'data')"/>
					<xforms:send submission="save-id"/>
				</xforms:action>
			</xforms:submission>

			<!-- **** NUDSHOARD **** -->
			<xforms:submission id="load-hoard" serialization="none" method="get" action="{instance('exist-url')}nomisma/objects/{instance('control-instance')/id}.xml" replace="instance"
				instance="hoard" xxforms:username="admin" xxforms:password="">
				<xforms:action ev:event="xforms-submit-error">
					<xforms:message level="modal">Error Loading object</xforms:message>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="save-hoard" ref="instance('hoard')" xxforms:username="admin" xxforms:password=""
				action="{instance('exist-url')}nomisma/objects/{instance('control-instance')/id}.xml" method="put" replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Save Error. Are all required inputs filled?</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xforms:insert nodeset="instance('doc')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/nudsHoard-to-rdf.xpl', 'data', instance('hoard'), 'data')"/>
					<xforms:send submission="save-id"/>
				</xforms:action>
			</xforms:submission>

			<!-- **** KML **** -->
			<xforms:submission id="save-kml" ref="instance('kml')" xxforms:username="admin" xxforms:password="" action="{instance('exist-url')}nomisma/kml/{instance('control-instance')/id}.kml"
				method="put" replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to save KML</xforms:message>
			</xforms:submission>

			<!-- **** DELETE **** -->
			<xforms:submission id="delete-id" action="{instance('exist-url')}nomisma/id/{instance('control-instance')/original_id}.xml" method="delete" replace="none" xxforms:username="admin"
				xxforms:password="">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error deleting id.</xforms:message>
			</xforms:submission>
			<xforms:submission id="delete-object" action="{instance('exist-url')}nomisma/objects/{instance('control-instance')/original_id}.xml" method="delete" replace="none" xxforms:username="admin"
				xxforms:password="">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error deleting nuds or nudsHoard record.</xforms:message>
			</xforms:submission>
			<xforms:submission id="delete-kml" action="{instance('exist-url')}nomisma/kml/{instance('control-instance')/original_id}.kml" method="delete" replace="none" xxforms:username="admin"
				xxforms:password="">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error deleting KML.</xforms:message>
			</xforms:submission>

			<!-- ************************* XQUERY FOR TYPES ************************** -->
			<xforms:submission id="xquery-collection" ref="instance('eXist-xquery')" action="{instance('exist-url')}nomisma/id" method="post" replace="instance" instance="types"
				xxforms:username="admin" xxforms:password="">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error querying eXist database.</xforms:message>
			</xforms:submission>

			<!-- ************************* SOLR SUBMISSIONS ************************** -->
			<!-- post instance to Solr -->
			<xforms:submission id="post-solr-doc" action="{instance('config')/solr_url}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
				<xforms:send submission="submit-commit" ev:event="xforms-submit-done"/>
			</xforms:submission>

			<!-- send commit -->
			<xforms:submission id="submit-commit" action="{instance('config')/solr_url}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Failed to commit to Solr index.</xforms:message>
			</xforms:submission>
		</xforms:model>

		<!-- XBL components -->
		<xi:include href="oxf:/xbl/numishare/cp-name/cp-name.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/type-date/type-date.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/denomination/denomination.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/description/description.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/dynasty/dynasty.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/material/material.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/mint/mint.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/nudsHeader/nudsHeader.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/reference/reference.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/region/region.xbl" xi:omit-xml-base="true"/>
		<xi:include href="oxf:/xbl/numishare/type-undertype/type-undertype.xbl" xi:omit-xml-base="true"/>
	</xhtml:head>

	<xhtml:body class="yui-skin-sam">
		<xhtml:div id="doc4">
			<!-- header -->
			<xxforms:variable name="display_path">../../</xxforms:variable>
			<xi:include href="header-admin.xml"/>

			<xhtml:div id="bd">
				<xhtml:div id="form">
					<xforms:group ref="instance('status')/text()">
						<xhtml:div class="success">
							<xforms:output ref="instance('status')"/>
						</xhtml:div>
					</xforms:group>

					<xhtml:div class="submission">
						<xforms:trigger appearance="minimal">
							<xforms:label class="file_control"><xhtml:img src="{$display_path}images/save.gif" alt="Save"/>Save</xforms:label>
							<xforms:action ev:event="DOMActivate">
								<xforms:action if="string-length(instance('control-instance')/original_id) = 0 or instance('control-instance')/original_id = instance('control-instance')/id">
									<xforms:action if="instance('control-instance')/type = 'type_series_item'">
										<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('coin'), 'data')"/>
										<xforms:send submission="save-kml"/>
										<xforms:send submission="save-coin"/>
									</xforms:action>
									<xforms:action if="instance('control-instance')/type = 'hoard'">
										<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('hoard'), 'data')"/>
										<xforms:send submission="save-kml"/>
										<xforms:send submission="save-hoard"/>
									</xforms:action>
									<xforms:action if="not(instance('control-instance')/type = 'type_series_item') and not(instance('control-instance')/type = 'hoard')">
										<xforms:action if="contains(instance('control-instance')/type, 'mint')">
											<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-kml.xpl', 'data', instance('doc'), 'data')"/>
											<xforms:send submission="save-kml"/>
										</xforms:action>
										<xforms:send submission="save-id"/>
									</xforms:action>
								</xforms:action>
								<xforms:action if="string-length(instance('control-instance')/original_id) &gt; 0 and instance('control-instance')/original_id != instance('control-instance')/id">
									<xforms:dispatch target="save-dialog" name="fr-show"/>
								</xforms:action>
							</xforms:action>
						</xforms:trigger>
						<xforms:submit submission="load-id" appearance="minimal">
							<xforms:label class="file_control"><xhtml:img src="{$display_path}images/recycle-green.png" alt="Load"/>Load</xforms:label>
						</xforms:submit>
						<xforms:trigger appearance="minimal">
							<xforms:label class="file_control"><xhtml:img src="{$display_path}images/remove.gif" alt="Delete"/>Delete</xforms:label>
							<xforms:action ev:event="DOMActivate"> </xforms:action>
						</xforms:trigger>
					</xhtml:div>

					<!-- dialogs -->
					<fr:alert-dialog id="save-dialog">
						<fr:label>Save</fr:label>
						<fr:message>The id has been changed from its original value</fr:message>
						<fr:positive-choice>
							<fr:label>Save: Replace</fr:label>
							<xforms:action ev:event="DOMActivate">
								<!-- delete old id first -->
								<xforms:action if="instance('control-instance')/type = 'type_series_item' or instance('control-instance')/type = 'hoard'">
									<xforms:send submission="delete-object"/>
									<xforms:send submission="delete-kml"/>
								</xforms:action>
								<xforms:action if="contains(instance('control-instance')/type, 'mint')">
									<xforms:send submission="delete-kml"/>
								</xforms:action>
								<xforms:send submission="delete-id"/>

								<!-- create new objects -->
								<xforms:action if="instance('control-instance')/type = 'type_series_item'">
									<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('coin'), 'data')"/>
									<xforms:send submission="save-kml"/>
									<xforms:send submission="save-coin"/>
								</xforms:action>
								<xforms:action if="instance('control-instance')/type = 'hoard'">
									<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('hoard'), 'data')"/>
									<xforms:send submission="save-kml"/>
									<xforms:send submission="save-hoard"/>
								</xforms:action>
								<xforms:action if="not(instance('control-instance')/type = 'type_series_item') and not(instance('control-instance')/type = 'hoard')">
									<xforms:action if="contains(instance('control-instance')/type, 'mint')">
										<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-kml.xpl', 'data', instance('doc'), 'data')"/>
										<xforms:send submission="save-kml"/>
									</xforms:action>
									<xforms:send submission="save-id"/>
								</xforms:action>
							</xforms:action>
						</fr:positive-choice>
						<fr:negative-choice>
							<fr:label>Save: Don't Replace</fr:label>
							<xforms:action ev:event="DOMActivate">
								<xforms:action if="instance('control-instance')/type = 'type_series_item'">
									<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('coin'), 'data')"/>
									<xforms:send submission="save-kml"/>
									<xforms:send submission="save-coin"/>
								</xforms:action>
								<xforms:action if="instance('control-instance')/type = 'hoard'">
									<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/object-to-kml.xpl', 'data', instance('hoard'), 'data')"/>
									<xforms:send submission="save-kml"/>
									<xforms:send submission="save-hoard"/>
								</xforms:action>
								<xforms:action if="not(instance('control-instance')/type = 'type_series_item') and not(instance('control-instance')/type = 'hoard')">
									<xforms:action if="contains(instance('control-instance')/type, 'mint')">
										<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-kml.xpl', 'data', instance('doc'), 'data')"/>
										<xforms:send submission="save-kml"/>
									</xforms:action>
									<xforms:send submission="save-id"/>
								</xforms:action>
							</xforms:action>
						</fr:negative-choice>
						<fr:neutral-choice>
							<fr:label>Cancel</fr:label>
						</fr:neutral-choice>
					</fr:alert-dialog>

					<xhtml:h1>Edit nomisma id</xhtml:h1>
					<xforms:group ref="instance('control-instance')">
						<xhtml:div>
							<xforms:select1 ref="type">
								<xforms:label>Type</xforms:label>
								<xforms:alert>Required</xforms:alert>
								<xforms:item>
									<xforms:label>Select...</xforms:label>
									<xforms:value/>
								</xforms:item>
								<xforms:itemset nodeset="instance('types')/report/type">
									<xforms:label ref="."/>
									<xforms:value ref="."/>
								</xforms:itemset>
								<xforms:action ev:event="xforms-value-changed">
									<xxforms:variable name="typeof" select="."/>
									<!-- if altering the type from its original value, remove all but skos:broader and set new value-->
									<xforms:action if="$typeof != substring-after(instance('doc')/@typeof, 'nm:')">
										<xforms:delete nodeset="instance('doc')/*"/>
										<xforms:insert origin="instance('prefLabel-template')" context="instance('doc')"/>
										<xforms:insert origin="instance('definition-template')" context="instance('doc')" nodeset="./child::node()[last()]"/>
										<xforms:setvalue ref="instance('doc')/@typeof" value="concat('nm:', $typeof)"/>
										<!-- set case, depending on $typeof -->
										<xforms:action if="$typeof = 'type_series_item'">
											<xforms:toggle case="coin-type"/>
										</xforms:action>
										<xforms:action if="$typeof = 'hoard'">
											<xforms:toggle case="hoard-case"/>
										</xforms:action>
										<xforms:action if="not($typeof = 'type_series_item') and not($typeof = 'hoard')">
											<xforms:toggle case="default"/>
										</xforms:action>
									</xforms:action>
								</xforms:action>
							</xforms:select1>
						</xhtml:div>
						<xhtml:div>
							<xforms:input ref="id">
								<xforms:label>id</xforms:label>
								<xforms:alert>Required</xforms:alert>
								<xforms:action ev:event="xforms-value-changed">
									<xxforms:variable name="id" select="."/>
									<xforms:setvalue ref="instance('doc')/@about" value="concat('[nm:', $id, ']')"/>
									<xforms:action if="instance('control-instance')/type = 'type_series_item'">
										<xforms:setvalue ref="instance('coin')/nuds:nudsHeader/nuds:nudsid" value="$id"/>
									</xforms:action>
									<xforms:action if="instance('control-instance')/type = 'hoard'">
										<xforms:setvalue ref="instance('hoard')/nh:nudsHeader/nh:nudsid" value="$id"/>
									</xforms:action>
								</xforms:action>
							</xforms:input>
						</xhtml:div>
					</xforms:group>

					<xforms:switch>
						<xforms:case id="default">
							<xhtml:div class="section">
								<xhtml:h2>Options</xhtml:h2>
								<xhtml:div class="trigger_container">
									<xforms:trigger appearance="minimal">
										<xforms:label>
											<xhtml:img src="{$display_path}images/add.gif"/>Preferred Label</xforms:label>
										<xforms:insert ev:event="DOMActivate" origin="instance('prefLabel-template')" context="instance('doc')" nodeset="./child::node()[last()]"/>
									</xforms:trigger>
									<xforms:group ref=".[count(instance('doc')/xhtml:div[@property='skos:definition']) = 0]">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<xhtml:img src="{$display_path}images/add.gif"/>Definition</xforms:label>
											<xforms:insert ev:event="DOMActivate" origin="instance('definition-template')" context="instance('doc')"/>
										</xforms:trigger>
									</xforms:group>
									<xforms:trigger appearance="minimal">
										<xforms:label>
											<xhtml:img src="{$display_path}images/add.gif"/>Alternate Label</xforms:label>
										<xforms:insert ev:event="DOMActivate" origin="instance('altLabel-template')" context="instance('doc')" nodeset="./child::node()[last()]"/>
									</xforms:trigger>
									<xforms:trigger appearance="minimal">
										<xforms:label>
											<xhtml:img src="{$display_path}images/add.gif"/>Related Link</xforms:label>
										<xforms:insert ev:event="DOMActivate" origin="instance('related-template')" context="instance('doc')" nodeset="./child::node()[last()]"/>
									</xforms:trigger>
									<xforms:group ref=".[count(instance('doc')/xhtml:div[@property='gml:pos']) = 0]">
										<xforms:trigger appearance="minimal">
											<xforms:label>
												<xhtml:img src="{$display_path}images/add.gif"/>Coordinates</xforms:label>
											<xforms:insert ev:event="DOMActivate" origin="instance('coordinates-template')" context="instance('doc')" nodeset="./child::node()[last()]"/>
										</xforms:trigger>
									</xforms:group>
								</xhtml:div>
								<xforms:group ref="instance('doc')">
									<xforms:repeat nodeset="xhtml:div[@property='skos:prefLabel']">
										<xhtml:div>
											<xforms:input ref=".">
												<xforms:label>Preferred Label</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<xforms:select1 ref="@xml:lang">
												<xforms:item>
													<xforms:label>Select...</xforms:label>
													<xforms:value/>
												</xforms:item>
												<xforms:itemset nodeset="instance('languages')/language">
													<xforms:label ref="."/>
													<xforms:value ref="@value"/>
												</xforms:itemset>
												<xforms:alert>Required</xforms:alert>
											</xforms:select1>
											<xforms:group ref=".[count(instance('doc')/xhtml:div[@property='skos:prefLabel'][@xml:lang='en']) &gt; 1]">
												<xforms:trigger appearance="minimal">
													<xforms:delete ev:event="DOMActivate" context="."/>
													<xforms:label>
														<xhtml:img src="{$display_path}images/remove.gif"/>
													</xforms:label>
												</xforms:trigger>
											</xforms:group>
											<xforms:group ref=".[not(@xml:lang='en')]">
												<xforms:trigger appearance="minimal">
													<xforms:delete ev:event="DOMActivate" context="."/>
													<xforms:label>
														<xhtml:img src="{$display_path}images/remove.gif"/>
													</xforms:label>
												</xforms:trigger>
											</xforms:group>
										</xhtml:div>
									</xforms:repeat>
									<xforms:repeat nodeset="xhtml:div[@property='skos:altLabel']">
										<xhtml:div>
											<xforms:input ref=".">
												<xforms:label>Alternate Label</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<xforms:select1 ref="@xml:lang">
												<xforms:item>
													<xforms:label>Select...</xforms:label>
													<xforms:value/>
												</xforms:item>
												<xforms:itemset nodeset="instance('languages')/language">
													<xforms:label ref="."/>
													<xforms:value ref="@value"/>
												</xforms:itemset>
												<xforms:alert>Required</xforms:alert>
											</xforms:select1>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" context="."/>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
										</xhtml:div>
									</xforms:repeat>
									<xforms:group ref="xhtml:div[@property='skos:definition']">
										<xhtml:div>
											<xforms:input ref=".">
												<xforms:label>Definition</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<xforms:select1 ref="@xml:lang">
												<xforms:item>
													<xforms:label>Select...</xforms:label>
													<xforms:value/>
												</xforms:item>
												<xforms:itemset nodeset="instance('languages')/language">
													<xforms:label ref="."/>
													<xforms:value ref="@value"/>
												</xforms:itemset>
											</xforms:select1>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" context="."/>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
										</xhtml:div>
									</xforms:group>
									<xforms:repeat nodeset="xhtml:div/xhtml:a[@rel='skos:related']">
										<xhtml:div>
											<xforms:input ref="@href">
												<xforms:label>Related Link</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
											<xforms:trigger appearance="minimal">
												<xforms:delete ev:event="DOMActivate" context="."/>
												<xforms:label>
													<xhtml:img src="{$display_path}images/remove.gif"/>
												</xforms:label>
											</xforms:trigger>
										</xhtml:div>
									</xforms:repeat>

									<xforms:group ref=".[count(xhtml:div[@property='gml:pos']) = 1]">
										<xhtml:h3>Coordinates</xhtml:h3>
										<xforms:trigger appearance="minimal">
											<xforms:action ev:event="DOMActivate">
												<xforms:delete context="."/>
												<!-- clear lat and lon -->
												<xforms:setvalue ref="instance('control-instance')/lat"/>
												<xforms:setvalue ref="instance('control-instance')/lon"/>
											</xforms:action>

											<xforms:label>
												<xhtml:img src="{$display_path}images/remove.gif"/>
											</xforms:label>
										</xforms:trigger>
										<xhtml:div>
											<xforms:input ref="instance('control-instance')/lat">
												<xforms:label>Latitude</xforms:label>
												<xforms:alert>Must be decimal integer between -180 and 180</xforms:alert>
												<xforms:action ev:event="xforms-value-changed">
													<xforms:setvalue ref="instance('doc')/div[@property='gml:pos']"
														value="concat(instance('control-instance')/lat, ' ', instance('control-instance')/lon)"/>
												</xforms:action>
											</xforms:input>
										</xhtml:div>
										<xhtml:div>
											<xforms:input ref="instance('control-instance')/lon">
												<xforms:label>Longitude</xforms:label>
												<xforms:alert>Must be decimal integer between -180 and 180</xforms:alert>
												<xforms:action ev:event="xforms-value-changed">
													<xforms:setvalue ref="instance('doc')/div[@property='gml:pos']"
														value="concat(instance('control-instance')/lat, ' ', instance('control-instance')/lon)"/>
												</xforms:action>
											</xforms:input>
										</xhtml:div>
										<!--<xhtml:div>
											<xforms:input ref="nm:latlongsource/@rdf:resource">
												<xforms:label>Source</xforms:label>
												<xforms:alert>Required</xforms:alert>
											</xforms:input>
										</xhtml:div>-->
									</xforms:group>
								</xforms:group>
							</xhtml:div>
						</xforms:case>
						<xforms:case id="coin-type">
							<xforms:group ref="instance('coin')/nuds:descMeta">
								<xhtml:div>
									<xforms:input ref="nuds:title">
										<xforms:label>Title</xforms:label>
										<xforms:alert>Required</xforms:alert>
									</xforms:input>
								</xhtml:div>
							</xforms:group>
							<fr:tabview>
								<!--**************************************** DESCMETA **********************************-->
								<fr:tab bind="typeDesc-tab">
									<fr:label>Descriptive Metadata</fr:label>
									<xhtml:h2>Typological Description</xhtml:h2>
									<numishare:type-undertype/>
								</fr:tab>
								<fr:tab bind="nudsHeader-tab">
									<fr:label>Descriptive Metadata</fr:label>
									<numishare:nudsHeader/>
								</fr:tab>
							</fr:tabview>
						</xforms:case>
						<xforms:case id="hoard-case"> hoard </xforms:case>
					</xforms:switch>
				</xhtml:div>
			</xhtml:div>
			<fr:xforms-inspector/>
			<!-- footer -->
			<!--<xi:include href="footer.xml"/>-->
		</xhtml:div>
	</xhtml:body>
</xhtml:html>
