<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema"
	xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:exist="http://exist.sourceforge.net/NS/exist" xmlns:nm="http://nomisma.org/id/" xmlns:ov="http://open.vocab.org/terms/" xmlns:owl="http://www.w3.org/2002/07/owl#"
	xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:skos="http://www.w3.org/2008/05/skos#" xmlns:batlas="http://atlantides.org/batlas/" xmlns:cc="http://creativecommons.org/ns#"
	xmlns:nuds="http://nomisma.org/id/nuds" xmlns:foaf="http://xmlns.com/foaf/0.1/" xmlns:gml="http://www.opengis.net/gml/">
	<xhtml:head>
		<title>nomisma.org: Administrative Interface</title>
		<link rel="stylesheet" type="text/css" href="/apps/nomisma/css/grids-min.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/nomisma/css/reset-fonts-grids.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/nomisma/css/base-min.css"/>
		<link rel="stylesheet" type="text/css" href="/apps/nomisma/css/fonts-min.css"/>

		<!-- nomisma styling -->
		<link rel="stylesheet" href="/apps/nomisma/css/style.css"/>
		<!--<link rel="stylesheet" href="/apps/nomisma/css/themes/smoothness.css"/>-->

		<!--<script type="text/javascript" src="/apps/nomisma/javascript/jquery-1.4.2.min.js"/>
		<script type="text/javascript" src="/apps/nomisma/javascript/get_components.js"/>
		<script type="text/javascript" src="/apps/nomisma/javascript/menu.js"/>-->


		<xforms:model>
			<xforms:instance id="exist-url">
				<xi:include href="exist-url.xml"/>
			</xforms:instance>

			<xforms:instance id="config">
				<config xmlns=""/>
			</xforms:instance>

			<xforms:instance id="status">
				<status/>
			</xforms:instance>

			<xforms:instance id="identifier">
				<id xmlns=""/>
			</xforms:instance>

			<xforms:instance id="rdf">
				<rdf:RDF xmlns=""/>
			</xforms:instance>

			<xforms:instance id="kml">
				<kml xmlns="http://www.opengis.net/kml/2.2"/>
			</xforms:instance>

			<xforms:instance id="term-template">
				<rdf:RDF xmlns:ov="http://open.vocab.org/terms/" xmlns:foaf="http://xmlns.com/foaf/0.1/" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:owl="http://www.w3.org/2002/07/owl#"
					xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:gml="http://www.opengis.net/gml/" xmlns:batlas="http://atlantides.org/batlas/" xmlns:nuds="http://nomisma.org/id/nuds"
					xmlns:skos="http://www.w3.org/2008/05/skos#" xmlns:cc="http://creativecommons.org/ns#" xmlns:nm="http://nomisma.org/id/">
					<skos:Concept rdf:about="">
						<skos:broader rdf:about="http://nomisma.org/id/numismatic_term"/>
						<skos:prefLabel xml:lang="en"/>
						<skos:definition xml:lang="en"/>
					</skos:Concept>
				</rdf:RDF>
			</xforms:instance>

			<xforms:instance id="control-instance">
				<control xmlns="">
					<id/>
				</control>
			</xforms:instance>

			<!-- eXist query for types -->
			<xforms:instance id="types">
				<types/>
			</xforms:instance>

			<xforms:instance id="type-template">
				<type xmlns=""/>
			</xforms:instance>

			<!-- eXist instances -->
			<xforms:instance id="eXist-xquery">
				<exist:query>
					<exist:text>&lt;report xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt; { for $i in
						distinct-values(collection()//skos:Concept[skos:broader/@rdf:about='http://nomisma.org/id/numismatic_term']/@rdf:about) order by substring-after($i, 'id/') return &lt;type> { $i } &lt;/type> }
						&lt;/report&gt;</exist:text>
				</exist:query>
			</xforms:instance>

			<xforms:instance id="eXist-result">
				<exist:result/>
			</xforms:instance>

			<!-- Solr instances -->
			<xforms:instance id="solr-doc">
				<add xmlns=""/>
			</xforms:instance>

			<xforms:instance id="addIndex">
				<add xmlns=""/>
			</xforms:instance>
			
			<xforms:instance id="deleteAll">
				<delete xmlns="">
					<query>id:*</query>
				</delete>
			</xforms:instance>

			<xforms:instance id="sendCommit">
				<commit/>
			</xforms:instance>

			<!-- **************** BINDINGS ********************** -->
			<xforms:bind nodeset="instance('term-template')">
				<xforms:bind nodeset="skos:Concept">
					<xforms:bind nodeset="@rdf:about" type="xs:anyURI"/>
					<xforms:bind nodeset="skos:prefLabel" required="true()"/>
					<xforms:bind nodeset="skos:definition" required="true()"/>
				</xforms:bind>
			</xforms:bind>

			<xforms:bind nodeset="instance('control-instance')">
				<xforms:bind nodeset="id" required="true()" type="xs:ID"/>
			</xforms:bind>

			<!-- **************** xforms-model-construct-done ********************** -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:send submission="load-config"/>
				<xforms:send submission="xquery-collection"/>
				<xforms:action ev:event="xforms-submit-done" xxforms:iterate="instance('eXist-result')/report/type">
					<xxforms:variable name="type" select="."/>
					<xforms:setvalue ref="instance('type-template')" value="$type"/>
					<xforms:insert origin="instance('type-template')" context="instance('types')" nodeset="./child::node()[last()]"/>
				</xforms:action>
			</xforms:action>

			<!-- ************* SUBMISSIONS **********************-->
			<!-- ************************* XQUERY FOR TYPES ************************** -->
			<xforms:submission id="xquery-collection" ref="instance('eXist-xquery')" action="{instance('exist-url')}nomisma/id" method="post" replace="instance" instance="eXist-result"
				xxforms:username="admin" xxforms:password="">
				<xforms:message level="modal" ev:event="xforms-submit-error">Error querying eXist database.</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-config" serialization="none" method="get" action="{instance('exist-url')}nomisma/config.xml" replace="instance" instance="config" xxforms:username="admin"
				xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to load config</xforms:message>
			</xforms:submission>

			<xforms:submission id="load-id" serialization="none" method="get" action="{instance('exist-url')}/nomisma/id/{instance('identifier')}.xml" replace="instance" instance="rdf"
				xxforms:username="admin" xxforms:password="">
				<xforms:message ev:event="xforms-submit-error" level="modal">Cannot load object: <xforms:output ref="instance('identifier')"/></xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<!-- extract Solr document, put into addIndex -->
					<xforms:insert nodeset="instance('solr-doc')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-solr.xpl', 'data', instance('rdf'), 'data')"/>
					<xforms:insert context="instance('addIndex')" nodeset="./child::node()[last()]" origin="instance('solr-doc')/doc"/>
					<!-- generate KML, post to eXist [only mints for now] -->
					<xforms:action if="contains(instance('rdf')/skos:Concept/skos:broader/@rdf:about, 'mint')">
						<xforms:insert nodeset="instance('kml')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-kml.xpl', 'data', instance('rdf'), 'data')"/>
						<xforms:send submission="save-kml"/>
					</xforms:action>
				</xforms:action>
			</xforms:submission>

			<xforms:submission id="save-id" ref="instance('term-template')" xxforms:username="admin" xxforms:password=""
				action="{instance('exist-url')}nomisma/id/{substring-after(instance('term-template')/skos:Concept/@rdf:about, 'id/')}.xml" method="put" replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Save Error. Are all required inputs filled?</xforms:message>
				<xforms:action ev:event="xforms-submit-done">
					<xxforms:hide dialog="add-term"/>
					<xforms:setvalue ref="instance('status')">Numismatic term saved.</xforms:setvalue>
					<!-- post to solr -->
					<xforms:insert nodeset="instance('addIndex')" origin="xxforms:call-xpl('oxf:/apps/nomisma/xpl/id-to-solr.xpl', 'data', instance('term-template'), 'data')"/>
					<xforms:send submission="post-solr-doc"/>

					<!-- remove inputs after save -->
					<xforms:setvalue ref="instance('term-template')/skos:Concept/@rdf:about"/>
					<xforms:setvalue ref="instance('term-template')/skos:Concept/skos:prefLabel"/>
					<xforms:setvalue ref="instance('term-template')/skos:Concept/skos:definition"/>
				</xforms:action>
			</xforms:submission>

			<!-- **** KML **** -->
			<xforms:submission id="save-kml" ref="instance('kml')" xxforms:username="admin" xxforms:password="" action="{instance('exist-url')}nomisma/kml/{instance('identifier')}.kml" method="put"
				replace="none">
				<xforms:message ev:event="xforms-submit-error" level="modal">Unable to save KML</xforms:message>
			</xforms:submission>

			<!--  **** SOLR SUBMISSIONS  **** -->
			<xforms:submission id="post-solr-doc" action="{instance('config')/solr_url}update" ref="instance('addIndex')" instance="addIndex" replace="instance" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Data Failed to POST to Solr. Index may be offline or URL is incorrect.</xforms:message>
				<xforms:send submission="submit-commit" ev:event="xforms-submit-done"/>
			</xforms:submission>
			
			<xforms:submission id="delete-all-from-solr" action="{instance('config')/solr_url}update" ref="instance('deleteAll')" instance="deleteAll" replace="none" method="post">
				<xforms:send ev:event="xforms-submit-done" submission="commit"/>
			</xforms:submission>

			<xforms:submission id="submit-commit" action="{instance('config')/solr_url}update" ref="instance('sendCommit')" instance="sendCommit" replace="none" method="post">
				<xforms:message ev:event="xforms-submit-error" level="modal">Failed to commit to Solr index.</xforms:message>
			</xforms:submission>
		</xforms:model>
	</xhtml:head>

	<xhtml:body class="yui-skin-sam">
		<xhtml:div id="doc4">
			<!-- header -->
			<xxforms:variable name="display_path">../</xxforms:variable>
			<xi:include href="header-admin.xml"/>
			<xhtml:div id="bd">
				<xhtml:div id="form">
					<xforms:group ref="instance('status')/text()">
						<xhtml:div class="success">
							<xforms:output ref="instance('status')"/>
						</xhtml:div>
					</xforms:group>
					<xhtml:h1>Nomisma Admin</xhtml:h1>
					<xhtml:ul>
						<xhtml:li>
							<xforms:trigger appearance="minimal">
								<xforms:label>Regenerate Solr/KML</xforms:label>
								<xforms:action ev:event="DOMActivate">
									<xforms:send submission="delete-all-from-solr"/>
									<xforms:setvalue ref="instance('eXist-xquery')/exist:text">&lt;report> { for $foo in collection() return &lt;item> {
										substring-after($foo/rdf:RDF/skos:Concept/@rdf:about, 'id/') } &lt;/item> } &lt;/report></xforms:setvalue>
									<xforms:send submission="xquery-collection"/>
									<xforms:action ev:event="xforms-submit-done">
										<xforms:action xxforms:iterate="instance('eXist-result')/report/item">
											<xxforms:variable name="id" select="."/>
											<xforms:setvalue ref="instance('identifier')" value="$id"/>
											<xforms:send submission="load-id"/>
										</xforms:action>
										<xforms:send submission="post-solr-doc"/>
										<xforms:setvalue ev:event="xforms-submit-done" ref="instance('status')">nomisma ids re-indexed into Solr.</xforms:setvalue>
									</xforms:action>
								</xforms:action>
							</xforms:trigger>
						</xhtml:li>
					</xhtml:ul>

					<xforms:group ref="instance('types')">
						<xhtml:div class="section">
							<xhtml:h3>Numismatic Terms</xhtml:h3>
							<xforms:trigger appearance="minimal">
								<xforms:label>
									<xhtml:img src="/apps/nomisma/images/add.gif"/>Add Term</xforms:label>
								<xxforms:show dialog="add-term" ev:event="DOMActivate"/>
							</xforms:trigger>
							<xhtml:ul>
								<xforms:repeat nodeset="type">
									<xhtml:li>
										<xhtml:a href="edit/?id={substring-after(., 'id/')}">
											<xforms:output ref="substring-after(., 'id/')"/>
										</xhtml:a>
									</xhtml:li>
								</xforms:repeat>
							</xhtml:ul>
						</xhtml:div>
					</xforms:group>

					<xxforms:dialog id="add-term" appearance="full" level="modal" close="false" draggable="true" visible="false">
						<xforms:label>Add Numismatic Term</xforms:label>
						<xhtml:div>
							<xforms:input ref="instance('control-instance')/id">
								<xforms:label>ID</xforms:label>
								<xforms:alert>Required, must be xs:ID</xforms:alert>
								<xforms:action ev:event="xforms-value-changed">
									<xxforms:variable name="id" select="."/>
									<xforms:setvalue ref="instance('term-template')/skos:Concept/@rdf:about" value="concat('http://nomisma.org/id/', $id)"/>
								</xforms:action>
							</xforms:input>
						</xhtml:div>
						<xforms:group ref="instance('term-template')/skos:Concept">
							<xhtml:div>
								<xforms:input ref="skos:prefLabel">
									<xforms:label>Label</xforms:label>
									<xforms:alert>Required</xforms:alert>
								</xforms:input>
							</xhtml:div>
							<xhtml:div>
								<xforms:input ref="skos:definition">
									<xforms:label>Definition</xforms:label>
									<xforms:alert>Required</xforms:alert>
								</xforms:input>
							</xhtml:div>
						</xforms:group>
						<xforms:trigger>
							<xforms:label>Save</xforms:label>
							<!-- save collections and XML files to config -->
							<xforms:action ev:event="DOMActivate">
								<xforms:send submission="save-id"/>
							</xforms:action>
						</xforms:trigger>
					</xxforms:dialog>
				</xhtml:div>
			</xhtml:div>




			<!-- footer -->
			<!--<xi:include href="footer.xml"/>-->
		</xhtml:div>
	</xhtml:body>
</html>
